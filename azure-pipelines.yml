trigger:
  branches:
    include:
      - main
      - dev

# Choose OS for the agent
# You can switch between ubuntu-latest or windows-latest as needed
pool:
  vmImage: 'ubuntu-latest'

steps:
  # Step 1: Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  # Step 2: Install dependencies and Playwright browsers
  - script: |
      npm ci
      npx playwright install --with-deps
    displayName: 'Install dependencies and browsers'

  # Step 3: Run Playwright tests (headless)
  - script: |
      npx playwright test --reporter=line
    displayName: 'Run Playwright tests (Headless)'

  # Optional: Run tests in headed mode (for debugging)
  # ⚠️ Headed mode is usually for local debugging only, not in CI
  # Uncomment if you really need it:
  # - script: |
  #     npx playwright test --headed
  #   displayName: 'Run Playwright tests (Headed)'

  # Step 4: Run tests again and generate Allure report
  - script: |
      npx playwright test --reporter=line,allure-playwright
      npx allure generate allure-results --clean -o allure-report
    displayName: 'Run Playwright tests and generate Allure report'

  # Step 5: Publish test results (if XML format exists)
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/test-results/*.xml'
      testRunTitle: 'Playwright Test Results'
    condition: succeededOrFailed()

  # Step 6: Publish Playwright HTML report as pipeline artifact
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: 'playwright-report'
      ArtifactName: 'playwright-report'
      publishLocation: 'Container'
    condition: succeededOrFailed()

  # Step 7: Publish Allure report as artifact
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: 'allure-report'
      ArtifactName: 'allure-report'
      publishLocation: 'Container'
    condition: succeededOrFailed()
